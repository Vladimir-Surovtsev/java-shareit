version: '3.8'
services:
  db:
    image: postgres:16.1
    container_name: postgres
    ports:
      - "5432:5432"
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=shareit
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=12355
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -q -d $$POSTGRES_DB -U $$POSTGRES_USER" ]
      timeout: 5s
      interval: 5s
      retries: 10
  db-init:
    image: postgres:16.1
    container_name: db-init
    depends_on:
      db:
        condition: service_healthy
    entrypoint:
      - bash
      - -c
      - |
        set -e
        psql postgresql://postgres:12355@db:5432/shareit -v ON_ERROR_STOP=1 <<-EOSQL
          DROP TABLE IF EXISTS users CASCADE;
          DROP TABLE IF EXISTS items CASCADE;
          DROP TABLE IF EXISTS bookings CASCADE;
          DROP TABLE IF EXISTS comments CASCADE;
          CREATE TABLE IF NOT EXISTS users (
              user_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
              name VARCHAR(30) NOT NULL,
              email VARCHAR(30) NOT NULL UNIQUE
          );
          CREATE TABLE IF NOT EXISTS items (
              item_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
              name VARCHAR(30) NOT NULL,
              description VARCHAR(150),
              is_available BOOLEAN NOT NULL,
              owner_id BIGINT NOT NULL,
              FOREIGN KEY (owner_id) REFERENCES users(user_id)
          );
          CREATE TABLE IF NOT EXISTS bookings (
              booking_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
              start_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
              end_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
              item_id BIGINT NOT NULL,
              booker_id BIGINT NOT NULL,
              status VARCHAR(10) NOT NULL,
              FOREIGN KEY (item_id) REFERENCES items(item_id),
              FOREIGN KEY (booker_id) REFERENCES users(user_id)
          );
          CREATE TABLE IF NOT EXISTS comments (
              comment_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
              text VARCHAR(150) NOT NULL,
              created_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
              item_id BIGINT NOT NULL,
              author_id BIGINT NOT NULL,
              FOREIGN KEY (item_id) REFERENCES items(item_id),
              FOREIGN KEY (author_id) REFERENCES users(user_id)
          );
        EOSQL